## 痛点与思路

- 痛点：用数组 + 每次 CLI 传 `--prefix/--target-dir` 很繁琐，且容易选错。
- 方案：引入“项目（project）”概念，一次选择项目，自动切换到该项目对应的上传目录/前缀与发布目标目录；支持环境变量或全局参数选择，默认项目可配置。

## 配置模型改造（最小侵入 + 兼容）

- 文件：`src/config/shipit.ts`
- 在顶层 Schema 增加 `projects` 字段（可选）：
  - 位置：`c:\home\Projects\frontend\node\shipit\src\config\shipit.ts:106-126`
  - 结构：
    ```ts
    projects: z.record(
      z.string(),
      z.object({
        providers: ProvidersSchema.partial().optional(),
        release: z.object({
          targetDir: z.string().optional(),
          allowedTargetDirPrefix: z.union([z.string(), z.array(z.string())]).optional(),
        }).partial().optional(),
        // 可扩展 hooks/artifact 等，当前先按需覆盖
      }),
    ).optional()
    ```
  - 语义：`projects[<name>]` 为该项目的覆盖配置；未覆盖的字段继续从顶层 `providers/release` 读取（保持现有兼容性）。

## 选择逻辑（一次选择，处处生效）

- 全局“激活项目”来源优先级：
  1. CLI 全局选项：`--project <name>`（新增）
  2. 环境变量：`SHIPIT_PROJECT=<name>`
  3. 自动推断（可选）：从上传文件路径中提取项目名（如 `./dist/projB/release.zip` → `projB`）
  4. 默认项目：`shipit.projectsDefault`（可选字段）或取 `projects` 的首个键

- 合并策略：
  - `effectiveConfig = deepMerge(shipitConfig, shipitConfig.projects?.[activeProject])`
  - 仅在运行期做浅/深合并，不改变现有类型导出；具体实现可放在 `src/config/shipit.ts` 中提供 `getEffectiveShipitConfig(activeProject?: string)`。

## CLI 改造

- 文件：`src/cli.ts`
  - 位置：`c:\home\Projects\frontend\node\shipit\src\cli.ts:6-14`
  - 增加全局选项：`.option('--project <name>', '选择当前项目')`

- `upload` 命令（文件：`src/commands/upload/index.ts`）
  - 位置参考：`c:\home\Projects\frontend\node\shipit\src\commands\upload\index.ts:36-48`、`:130-151`、`:153-175`
  - 获取激活项目并取覆盖配置：`const cfg = getEffectiveShipitConfig(activeProject)`
  - 构建 `OSS key`：使用项目覆盖后的 `providers.oss.prefix`
  - 服务器 `targetDir`：使用项目覆盖后的 `providers.server.targetDir`
  - 交互模式：当 `--interactive` 且存在多个项目时，先给出项目选择列表；选中后沿用整个流程（更好用）。

- `release` 命令（文件：`src/commands/release/index.ts`）
  - `list/publish/download` 全部通过 `effectiveConfig` 获取 `prefix/targetDir/白名单`，一次选择后处处生效。

## 用户配置示例（更顺手）

- 文件：`c:\home\work\shipit.config.js`
```js
module.exports = {
  // 顶层默认（不选项目时使用）
  providers: {
    oss: { bucket: 'my-bucket', prefix: 'releases/' },
    server: { baseUrl: 'https://upload.example.com', endpoint: 'https://upload.example.com/api/upload', targetDir: 'D:/deploy/default' },
  },
  release: { defaultProvider: 'oss', targetDir: 'D:/deploy', allowedTargetDirPrefix: 'D:/deploy' },

  // 多项目覆盖（一次选择即可）
  projects: {
    projA: {
      providers: {
        oss: { prefix: 'projA/releases/' },
        server: { targetDir: 'D:/deploy/projA/releases' },
      },
      release: { allowedTargetDirPrefix: ['D:/deploy/projA', 'D:/deploy/shared'] },
    },
    projB: {
      providers: {
        oss: { prefix: 'projB/releases/' },
        server: { targetDir: 'D:/deploy/projB/releases' },
      },
      release: { allowedTargetDirPrefix: ['D:/deploy/projB'] },
    },
  },
  // 可选默认项目
  projectsDefault: 'projA',
}
```

## 优势

- 使用体验更顺：只需指定 `--project projA`（或配置默认），上传/发布全流程自动使用对应目录，避免每次选 `--prefix/--target-dir`。
- 兼容旧配置：不声明 `projects` 时保持旧行为；已有脚本无需修改。
- 便于扩展：以后可在项目级覆盖 `hooks/artifact` 等，满足差异化需求。

## 测试与验证

- 单元测试：`projects` 合并逻辑、优先级（CLI > env > auto > default）、Windows 路径归一化。
- 集成测试：
  - `shipit upload --project projA` 输出包含 `projA/releases/`（dry-run 断言）。
  - `shipit release list --project projB` 使用 `projB/releases/` 前缀。
  - `publish/download` 针对 `allowedTargetDirPrefix` 的数组白名单校验。
- 质量脚本：`pnpm qa` 通过。

## 变更点导航

- `src/config/shipit.ts:106-126` 增加 `projects` 与可选 `projectsDefault` 字段；提供 `getEffectiveShipitConfig()`。
- `src/cli.ts:6-14` 新增全局 `--project` 选项。
- `src/commands/upload/index.ts` 与 `src/commands/release/index.ts` 接入 `effectiveConfig` 并在交互模式优先选择项目。

## 下一步

- 若您认可此“项目维度”方案，我将按上述文件位置实施改造并补充测试。